# 함수 기반 인덱스

함수 기반 인덱스는 칼럼의 값을 변경해서 만들어진 값에 대해 인덱스를 구축할 때 사용합니다. 
두 가지 방법이 있습니다: 
+ 가상 칼럼을 이용한 인덱스와 직접 함수를 이용한 인덱스입니다.

## 가상 칼럼을 이용한 인덱스
MySQL 8.0 버전부터 가상 칼럼을 추가하고 그 칼럼에 인덱스를 생성할 수 있습니다.

### 예시
```sql
-- 가상컬럼을 포함한 테이블 생성
CREATE TABLE tb_virtual (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(20),
    reg_date DATETIME
);

-- 데이터 삽입
INSERT INTO tb_virtual (name, reg_date) VALUES
    ('John', '2023-09-01 10:00:00'),
    ('Alice', '2023-09-01 11:30:00'),
    ('Bob', '2023-09-02 15:45:00'),
    ('Eve', '2023-09-03 09:15:00');

-- 가상 칼럼 추가 및 인덱스 생성
ALTER TABLE tb_virtual 
  ADD yyyy_mm CHAR(7) AS (LEFT(reg_date, 7)) VIRTUAL,
  ADD INDEX ix_yyyy_mm (yyyy_mm);

-- 데이터 조회
SELECT * FROM tb_virtual;
```  
+ 실제 `yyyy_mm` 칼럼이 생성되어 테이블 구조가 변경된 것을 확인할 수 있습니다.
    ```SQL
    +----+-------+---------------------+---------+
    | id | name  | reg_date            | yyyy_mm |
    +----+-------+---------------------+---------+
    |  1 | John  | 2023-09-01 10:00:00 | 2023-09 |
    |  2 | Alice | 2023-09-01 11:30:00 | 2023-09 |
    |  3 | Bob   | 2023-09-02 15:45:00 | 2023-09 |
    |  4 | Eve   | 2023-09-03 09:15:00 | 2023-09 |
    +----+-------+---------------------+---------+
    ```

## 함수를 이용한 인덱스
직접 함수를 이용하여 인덱스를 생성할 수 있습니다.

### 예시
```sql
-- 함수 기반 인덱스를 포함한 테이블 생성
CREATE TABLE tb_fuction (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(20),
    reg_date DATETIME,
    INDEX ix_yyyy_mm ((LEFT(reg_date, 7)))
);

-- 데이터 삽입
INSERT INTO tb_fuction (name, reg_date) VALUES
    ('John', '2023-09-01 10:00:00'),
    ('Alice', '2023-09-01 11:30:00'),
    ('Bob', '2023-09-02 15:45:00'),
    ('Eve', '2023-09-03 09:15:00');

-- 인덱스를 이용한 데이터 조회
SELECT * FROM tb_fuction WHERE LEFT(reg_date,7) = '2023-09';
```
+ 칼럼은 추가되지 않았지만 인덱스 사용은 확인할 수 있습니다.
  ```SQL
  +----+-------+---------------------+
  | id | name  | reg_date            |
  +----+-------+---------------------+
  |  1 | John  | 2023-09-01 10:00:00 |
  |  2 | Alice | 2023-09-01 11:30:00 |
  |  3 | Bob   | 2023-09-02 15:45:00 |
  |  4 | Eve   | 2023-09-03 09:15:00 |
  +----+-------+---------------------+
  ```
+ 실행계획(`EXPLAIN`)
  ```SQL
  +----+-------------+------------+------+---------------+------------+---------+-------+
  | id | select_type | table      | type | possible_keys | key        | key_len | ref   |
  +----+-------------+------------+------+---------------+------------+---------+-------+
  |  1 | SIMPLE      | tb_fuction | ref  | ix_yyyy_mm    | ix_yyyy_mm | 17      | const |
  +----+-------------+------------+------+---------------+------------+---------+-------+ 
  ```  
  
함수를 이용한 인덱스는 테이블 구조를 변경하지 않고 인덱스를 생성할 수 있습니다.